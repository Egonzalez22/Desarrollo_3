<odoo>
    <data>

        <template id="fe_personalizacion.kude" inherit_id="facturacion_electronica_py.factura">

            <!-- reemplazamos el ultimo tr para agregar el nombre del vendedor -->
            <xpath expr="//table[@id='table_receptor']" position="replace">
                <table id="table_receptor" class="border-table font-small">
                    <tr>
                        <td style="padding-top:10px">
                            <span class="bold">Fecha y hora de emisión: </span>
                            <span t-field="o.invoice_datetime" />
                        </td>
                        <td>
                            <span class="bold">Cond. de venta: </span>
                            <t t-if="o.invoice_date==o.invoice_date_due">
                                Contado
                            </t>
                            <t t-if="o.invoice_date!=o.invoice_date_due">
                                Crédito
                            </t>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span class="bold">RUC/documento de identidad: </span>
                            <t t-if="o.partner_id.contribuyente">
                                <span t-field="o.partner_id.vat" /> 
                            </t>
                            <t t-if="not o.partner_id.contribuyente">
                                <span t-field="o.partner_id.nro_documento" />
                            </t>
                        </td>
                        <td t-if="o.invoice_date!=o.invoice_date_due">
                            <span class="bold">Plazo: </span>
                            <span t-esc="o.invoice_payment_term_id.name" />
                        </td>
                        <td t-else="">
                            
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span class="bold">Nombre Fantasía: </span>
                            <span t-field="o.partner_id.nombre_fantasia" />
                        </td>
                        <td>
                            <span class="bold">Código Cliente: </span>
                            <span t-field="o.partner_id.ref" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span class="bold">Nombre o razón social: </span>
                            <span t-field="o.partner_id" />
                        </td>
                        <td>
                            <span class="bold">Moneda: </span>
                            <span t-field="o.currency_id" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span class="bold">Dirección: </span>
                            <span t-field="o.partner_id.street" />
                        </td>
                        <td>
                            <span class="bold">Tipo de cambio: </span>
                            <t t-if="o.currency_id.name == 'USD'">
                                <span t-esc="o.obtener_cotizacion()" />
                            </t>
                        </td>

                    </tr>
                    <tr>
                        <td>
                            <span class="bold">Teléfono: </span>
                            <span t-field="o.partner_id.phone" />
                        </td>
                        <td>
                            <span class="bold">Tipo de operación: </span>
                            <span t-field="o.iTipTra" />
                        </td>
                    </tr>
                    <!-- Si es nota de credito mostramos el documento asociado -->
                    <tr t-if="o.move_type=='out_refund'">
                        <td>
                            <span class="bold">Documento asociado: </span>
                            <t t-if="o.nro_factura_asociada.fe_valida">
                                <span t-field="o.nro_factura_asociada.cdc" />
                            </t>
                            <t t-else="">
                                <span t-field="o.nro_factura_asociada.name" />
                            </t>
                        </td>
                        <td>
                            <span class="bold">Tipo de documento asociado: </span>
                            <t t-if="o.nro_factura_asociada.fe_valida">
                                FE
                            </t>
                            <t t-else="">
                                Preimpreso
                            </t>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding-bottom:10px">
                            <span class="bold">Vendedor: </span>
                            <span t-field="o.vendedor" />
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>

            </xpath>



            <!-- reemplazamos los detalles del kude -->
            <xpath expr="//table[@id='table_detalles']/tbody" position="replace">
                <tbody>
                    <t t-set="subtotalExentas" t-value="0" />
                    <t t-set="subtotalCinco" t-value="0" />
                    <t t-set="subtotalDiez" t-value="0" />
                    
                    <t t-foreach="o.invoice_line_ids" t-as="l">
                        <!-- solo mostramos si la cantidad es mayor a 0 -->
                        <tr t-if="l.quantity > 0">
                            <!-- codigo -->
                            <td class="lineaDetalle" style="width:5%">
                                <t t-if="l.product_id and l.product_id.barcode">
                                    <span t-field="l.product_id.barcode" />
                                </t>
                                <t t-else="">
                                    <span></span>
                                </t>
                            </td>
                            <!-- cantidad -->
                            <td class="lineaDetalle" style="width:5%">
                                <span t-esc="l.quantity" />
                            </td>
                            <!-- descripcion -->
                            <td class="lineaDetalleIzquierda" style="width:40%">
                                <t t-esc="l.obtener_nombre_linea_kude()" />
                            </td>
                            <!-- precio unit -->
                            <td class="lineaDetalle" style="width:10%">
                                <span t-esc="o.format_monto_kude(l.price_unit)" />
                            </td>
                            <!-- descuento -->
                            <td class="lineaDetalle" style="width:10%">
                                <t t-if="l.getdDescItem() > 0">
                                    <span t-esc="o.format_monto_kude(l.getdDescItem())" />
                                </t>
                                <t t-if="l.getdDescGloItem() > 0">
                                    <span t-esc="o.format_monto_kude(l.getdDescGloItem())" />
                                </t>
                            </td>
                            <!-- exenta -->
                            <t t-if="l.tax_ids.amount==0.0000" style="width:10%">
                                <td class="lineaDetalle" style="width:7%">
                                    <t t-set="subtotal1" t-value="l.getdTotOpeItem()" />
                                    <span t-esc="o.format_monto_kude(subtotal1)" />
                                    <t t-set="subtotalExentas" t-value="subtotalExentas+subtotal1" />
                                </td>
                                <td class="lineaDetalle" style="width:7%" />
                                <td class="lineaDetalle" style="width:7%" />
                            </t>
                            <!-- monto iva 5 -->
                            <t t-if="l.tax_ids.amount==5.0000" style="width:10%">
                                <td class="lineaDetalle" style="width:7%" />
                                <td class="lineaDetalle" style="width:7%">
                                    <t t-set="subtotal1" t-value="l.getdTotOpeItem()" />
                                    <span t-esc="o.format_monto_kude(subtotal1)" />
                                    <t t-set="subtotalCinco" t-value="subtotalCinco+subtotal1" />
                                </td>
                                <td class="lineaDetalle" style="width:7%" />
                            </t>
                            <!-- monto iva 10 -->
                            <t t-if="l.tax_ids.amount==10.0000" style="width:10%">
                                <td class="lineaDetalle" style="width:7%" />
                                <td class="lineaDetalle" style="width:7%" />
                                <td class="lineaDetalle" style="width:7%">
                                    <t t-set="subtotal1" t-value="l.getdTotOpeItem()" />
                                    <span t-esc="o.format_monto_kude(subtotal1)" />
                                    <t t-set="subtotalDiez" t-value="subtotalDiez+subtotal1" />
                                </td>
                            </t>
                        </tr>
                    </t>

                </tbody>
            </xpath>
        </template>

        <record id="facturacion_electronica_py.paperformat_factura" model="report.paperformat">
            <field name="name">Facturas Electrónicas</field>
            <field name="format">A4</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">87</field>
            <field name="margin_bottom">60</field>
            <field name="margin_left">5</field>
            <field name="margin_right">5</field>
            <field name="header_line" eval="False" />
            <field name="header_spacing">87</field>
            <field name="disable_shrinking" eval="True" />
            <field name="dpi">96</field>
        </record>

    </data>
</odoo>